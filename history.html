<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç ‚Äì —ñ—Å—Ç–æ—Ä—ñ—è</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
    }
    h2 {
      margin-bottom: 5px;
    }
    #userInfo {
      color: #555;
      margin-bottom: 15px;
    }
    .msg {
      margin: 3px 0;
    }
    .me {
      font-weight: bold;
    }
    .bot {
      font-weight: bold;
    }
    .time {
      color: #888;
      font-size: 12px;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h2>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</h2>
  <div id="userInfo"></div>
  <div id="history"></div>

  <p>
    <a href="chat.html">‚¨Ö –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —á–∞—Ç—É</a>
  </p>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const historyDiv = document.getElementById("history");
    const userInfoDiv = document.getElementById("userInfo");

    function getCurrentUserFromToken() {
      const token = localStorage.getItem("token");
      if (!token) return null;
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        // payload = { id, username, iat, exp, ... }
        return payload;
      } catch {
        return null;
      }
    }

    function addLine(who, text, date) {
      const p = document.createElement("div");
      p.className = "msg";

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      timeSpan.textContent = date ? `[${date}]` : "";

      const whoSpan = document.createElement("span");
      whoSpan.className = (who === "–í–∏" ? "me" : "bot");
      whoSpan.textContent = who + ": ";

      p.appendChild(timeSpan);
      p.appendChild(whoSpan);
      p.append(text);

      historyDiv.appendChild(p);
    }

    async function loadHistory() {
      const user = getCurrentUserFromToken();
      if (!user) {
        userInfoDiv.textContent =
          "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∫—Ä–∏–π—Ç–µ —á–∞—Ç, —É–≤—ñ–π–¥—ñ—Ç—å, –∞ –ø–æ—Ç—ñ–º –∑–Ω–æ–≤—É –∑–∞–π–¥—ñ—Ç—å –≤ —ñ—Å—Ç–æ—Ä—ñ—é.";
        return;
      }

      const userId = user.id;
      const username = user.username;
      userInfoDiv.textContent = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${username} (ID: ${userId})`;

      // –ë–µ—Ä–µ–º–æ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ –ø–æ —á–∞—Å—É
      const q = query(
        collection(db, "messages"),
        orderBy("createdAt", "asc")
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        historyDiv.textContent = "–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è.";
        return;
      }

      snap.forEach(docSnap => {
        const data = docSnap.data();

        // –§—ñ–ª—å—Ç—Ä –ø–æ userId ‚Äì –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        if (data.userId !== userId) return;

        let timeStr = "";
        try {
          if (data.createdAt && data.createdAt.toDate) {
            const d = data.createdAt.toDate();
            timeStr = d.toLocaleString();
          }
        } catch (_) {}

        // üîπ –ù–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç: –æ–¥–Ω–∞ –ø–∞—Ä–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ
        if (data.userText !== undefined && data.botText !== undefined) {
          addLine("–í–∏", data.userText, timeStr);
          addLine("–ë–æ—Ç", data.botText, ""); // –¥—Ä—É–≥—É —Å—Ç—Ä–æ–∫—É –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —á–∞—Å—É
          return;
        }

        // üîπ –°—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç: role + text (–Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫)
        if (data.role && data.text) {
          const who = data.role === "assistant" ? "–ë–æ—Ç" : "–í–∏";
          addLine(who, data.text, timeStr);
          return;
        }

        // –Ü–Ω—à–∏–π —Ñ–æ—Ä–º–∞—Ç ‚Äì –ø—Ä–æ—Å—Ç–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ, —â–æ–± –Ω–µ –±—É–ª–æ "undefined"
      });
    }

    loadHistory().catch(err => {
      console.error("History load error:", err);
      historyDiv.textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó.";
    });
  </script>
</body>
</html>
