<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ß–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; }
    #chat { border: 1px solid #ccc; height: 320px; overflow-y: auto; padding: 10px; }
    .msg { margin: 6px 0; }
    .me { font-weight: bold; }
    .bot { font-weight: bold; }
    .row { display: flex; gap: 8px; margin-top: 10px; }
    input { flex: 1; padding: 10px; }
    button { padding: 10px 14px; cursor: pointer; }
    .hint { color: #777; font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>–ß–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</h2>

  <div id="chat"></div>

  <div class="row">
    <input id="msg" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
    <button id="sendBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </div>

  <div class="hint">
    –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –∑–º—ñ–Ω–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Äî –æ—á–∏—Å—Ç–∏ —Ç–æ–∫–µ–Ω:
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>

  <p>
    <a href="history.html">–ü–µ—Ä–µ–π—Ç–∏ –≤ –æ—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç (—ñ—Å—Ç–æ—Ä—ñ—è)</a>
  </p>
  


  <!-- saveToFirestore -->
 <script type="module">
  import { db } from "./firebase.js";
  import {
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

 window.saveToFirestore = async (userId, userText, botText) => {
  try {
    const ref = await addDoc(collection(db, "messages"), {
      userId,
      userText,
      botText,
      createdAt: serverTimestamp()
    });

    console.log("Saved pair:", ref.id);
  } catch (e) {
    console.error("Save pair error:", e);
  }
};

  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π —á–∞—Ç -->
  <script>
    const API = "http://localhost:3000";
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function addLine(who, text) {
      const p = document.createElement("div");
      p.className = "msg";
      p.innerHTML = `<span class="${who === '–í–∏' ? 'me' : 'bot'}">${who}:</span> ${text}`;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    function getUserIdFromToken(token) {
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        return payload.id;
      } catch {
        return "unknown";
      }
    }

    async function ensureLogin() {
      let token = localStorage.getItem("token");
      if (token) return token;

      const username = prompt("–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω (username):");
      const password = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å:");
      if (!username || !password) throw new Error("No credentials");

      // —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (—ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É —è–∫—â–æ –≤–∂–µ —ñ—Å–Ω—É—î)
      await fetch(API + "/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      }).catch(() => {});

      // –ª–æ–≥—ñ–Ω
      const res = await fetch(API + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      if (!res.ok || !data.token) throw new Error(data.error || "Login failed");
      localStorage.setItem("token", data.token);
      addLine("–ë–æ—Ç", `‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ ${username}`);
      return data.token;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;

      addLine("–í–∏", text);
      input.value = "";
      sendBtn.disabled = true;

      try {
        const token = await ensureLogin();
        const payload = JSON.parse(atob(token.split(".")[1]));
        const userId = payload.id;
        const username = payload.username;


        const res = await fetch(API + "/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ message: text })
        });

        if (res.status === 401) {
          localStorage.removeItem("token");
          addLine("–ë–æ—Ç", "üîê –°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å. –ù–∞—Ç–∏—Å–Ω–∏ ¬´–ù–∞–¥—ñ—Å–ª–∞—Ç–∏¬ª —â–µ —Ä–∞–∑.");
          return;
        }

        const data = await res.json();
        const reply = data?.reply;

        if (!reply) {
          addLine("–ë–æ—Ç", "‚ùå –ù–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞");
          return;
        }

        addLine("–ë–æ—Ç", reply);

        // Firestore (–ø–∏—à–µ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É userId)
        if (window.saveToFirestore) {
          try {
            await window.saveToFirestore(userId, text, reply);

          } catch (e) {
            console.warn("Firestore save skipped:", e);
          }
        }

      } catch (e) {
        console.error("SEND ERROR:", e);
        addLine("–ë–æ—Ç", "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–ª–æ–≥—ñ–Ω—É");
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      addLine("–ë–æ—Ç", "üëã –í–∏ –≤–∏–π—à–ª–∏. –ù–∞—Å—Ç—É–ø–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥—ñ–Ω.");
    });

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    addLine("–ë–æ—Ç", "–ü—Ä–∏–≤—ñ—Ç! –ù–∞–ø–∏—à–∏ –ø–∏—Ç–∞–Ω–Ω—è üôÇ");
  </script>
</body>
</html>
